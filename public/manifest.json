/* =======================================================
   HyperCalc â€” Smart Calculator PWA Service Worker v5.0
   Enterpriseâ€‘grade | Offlineâ€‘First | Selfâ€‘Updating
======================================================== */

const APP_VERSION = '5.0';
const CACHE_NAME = `hypercalc-cache-${APP_VERSION}`;

const PRECACHE_ASSETS = [
  './',
  './index.html',
  './style.css',

  // Core UI
  './ui.js',
  './canvas-measure.js',
  './geometry.js',

  // Physics Engine
  './public/physics/body.js',
  './public/physics/world.js',
  './public/physics/integrator.js',
  './public/physics/sandbox.js',
  './public/ui/sandbox-ui.js',

  // WASM (Ø§Ú¯Ø± Ù‡Ø³Øª)
  './public/Rust/hypercalc_wasm.js',

  // App logic
  './calculator.js',
  './auto_trainer.js',

  // PWA meta
  './manifest.json',
  './assets/icon-192.png',
  './assets/icon-512.png'
];

/* =========================
   Install
========================= */
self.addEventListener('install', event => {
  console.log(`ðŸŸ¡ Installing HyperCalc v${APP_VERSION}`);

  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => {
      return cache.addAll(PRECACHE_ASSETS);
    })
  );

  self.skipWaiting();
});

/* =========================
   Activate
========================= */
self.addEventListener('activate', event => {
  console.log(`ðŸŸ¢ Activating HyperCalc v${APP_VERSION}`);

  event.waitUntil(
    caches.keys().then(keys =>
      Promise.all(
        keys
          .filter(k => k !== CACHE_NAME)
          .map(k => {
            console.log(`ðŸ§¹ Removing old cache: ${k}`);
            return caches.delete(k);
          })
      )
    )
  );

  self.clients.claim();
});

/* =========================
   Fetch Strategy
   â€” Offline First + Auto Refresh
========================= */
self.addEventListener('fetch', event => {
  const req = event.request;

  // Ignore dev tools / chrome extensions
  if (req.url.startsWith('chrome-extension')) return;

  event.respondWith(
    caches.match(req).then(cacheRes => {
      if (cacheRes) {
        // Background refresh
        fetch(req)
          .then(networkRes => {
            caches.open(CACHE_NAME).then(cache => {
              cache.put(req, networkRes.clone());
            });
          })
          .catch(() => {});
        return cacheRes;
      }

      return fetch(req)
        .then(networkRes => {
          caches.open(CACHE_NAME).then(cache => {
            cache.put(req, networkRes.clone());
          });
          return networkRes;
        })
        .catch(() => {
          if (req.destination === 'document') {
            return caches.match('./index.html');
          }
        });
    })
  );
});

/* =========================
   Force Update Handler
========================= */
self.addEventListener('message', e => {
  if (e.data === 'UPDATE_NOW') self.skipWaiting();
});
