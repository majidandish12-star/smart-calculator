<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ§® Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯ + Reality</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 420px;
      background: #020617;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,.5);
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 1.4rem;
      margin: 0;
    }

    header p {
      font-size: .9rem;
      opacity: .7;
    }

    .display {
      background: #020617;
      border: 1px solid #1e293b;
      border-radius: 12px;
      padding: 15px;
      font-size: 1.6rem;
      text-align: left;
      overflow-x: auto;
      margin-bottom: 15px;
      min-height: 48px;
    }

    .keys {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    button {
      padding: 16px;
      font-size: 1.1rem;
      border: none;
      border-radius: 12px;
      background: #1e293b;
      color: #e5e7eb;
      cursor: pointer;
    }

    button:active { transform: scale(.96); }

    .op { background: #334155; }
    .equal { grid-column: span 2; background: #2563eb; }
    .clear { background: #7f1d1d; }
    .extra { background: #047857; } /* Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Reality/Export */
  </style>
</head>

<body>

<div class="app">
  <header>
    <h1>ğŸ§® Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯</h1>
    <p>Ù†Ø³Ø®Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ â€“ Ù†ÛŒÙ…Ù‡â€ŒØ¢ÙÙ„Ø§ÛŒÙ† / Ø¢Ù†Ù„Ø§ÛŒÙ†</p>
  </header>

  <div id="display" class="display">0</div>

  <div class="keys">
    <button class="clear">C</button>
    <button class="op">Ã·</button>
    <button class="op">Ã—</button>
    <button class="op">âˆ’</button>

    <button>7</button>
    <button>8</button>
    <button>9</button>
    <button class="op">+</button>

    <button>4</button>
    <button>5</button>
    <button>6</button>
    <button class="op">.</button>

    <button>1</button>
    <button>2</button>
    <button>3</button>
    <button class="equal">=</button>

    <button>0</button>
    <button class="extra" id="uploadBtn">ğŸ“· ØªØ­Ù„ÛŒÙ„ ØªØµÙˆÛŒØ±</button>
    <button class="extra" id="exportCSVBtn">CSV</button>
    <button class="extra" id="exportPDFBtn">PDF</button>
  </div>

  <input type="file" id="upload" accept="image/*" style="display:none" />

  <canvas id="canvas" width="400" height="300" style="border:1px solid #1e293b;margin-top:15px;"></canvas>
  <div id="chartContainer" style="width:100%; height:250px;margin-top:15px;"></div>
</div>

<script type="module">

import { SmartEngine } from './smart-engine.js';
import Chart from 'https://cdn.jsdelivr.net/npm/chart.js';
import { jsPDF } from 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';

const display = document.getElementById("display");
const engine = new SmartEngine('engineer');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const uploadInput = document.getElementById('upload');
const chartContainer = document.getElementById('chartContainer');
let chart = null;

// =======================
// Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ø¯Ø¯ÛŒ Ùˆ Ø±ÛŒØ§Ø¶ÛŒ
// =======================
document.querySelectorAll(".keys button").forEach(btn => {
  btn.addEventListener("click", async () => {
    const val = btn.textContent;

    if (val === "C") {
      engine.clearHistory();
      engine.clearRealityHistory();
      display.textContent = "0";
      if (chart) chart.destroy();
      return;
    }

    if (val === "=") {
      try {
        const res = engine.evaluate(display.textContent);
        display.textContent = res.result;
      } catch {
        display.textContent = "Ø®Ø·Ø§";
      }
      return;
    }

    // Reality / Export buttons
    if (val === "ğŸ“· ØªØ­Ù„ÛŒÙ„ ØªØµÙˆÛŒØ±") {
      uploadInput.click();
      return;
    }
    if (val === "CSV") { exportCSV(); return; }
    if (val === "PDF") { exportPDF(); return; }

    engine.input ? engine.input(val) : display.textContent += val;
    display.textContent = engine.getDisplayValue ? engine.getDisplayValue() : display.textContent;
  });
});

// =======================
// ØªØ­Ù„ÛŒÙ„ ØªØµÙˆÛŒØ± / ÙˆØ§Ù‚Ø¹ÛŒØª
// =======================
uploadInput.addEventListener("change", async () => {
  const file = uploadInput.files[0];
  if (!file) return alert('ÛŒÚ© ØªØµÙˆÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!');

  const data = await engine.analyzeReality(file);
  engine.displayResult('display', data);
  updateChart();
});

// =======================
// Ù†Ù…ÙˆØ¯Ø§Ø±
// =======================
function updateChart() {
  const history = engine.getRealityHistory();
  if (!history.length) return;
  const labels = history.map((_, i) => `Ø´ÛŒØ¡ ${i+1}`);
  const weights = history.map(h => h.weight);
  const volumes = history.map(h => h.volume);
  const energies = history.map(h => h.physics.kinetic_energy);

  if (chart) chart.destroy();

  chart = new Chart(chartContainer.getContext('2d'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'ÙˆØ²Ù† (kg)', data: weights, backgroundColor: 'rgba(54, 162, 235, 0.6)' },
        { label: 'Ø­Ø¬Ù… (mÂ³)', data: volumes, backgroundColor: 'rgba(255, 206, 86, 0.6)' },
        { label: 'Ø§Ù†Ø±Ú˜ÛŒ Ø¬Ù†Ø¨Ø´ÛŒ (J)', data: energies, backgroundColor: 'rgba(75, 192, 192, 0.6)' }
      ]
    },
    options: { responsive:true, plugins:{legend:{position:'top'}} }
  });
}

// =======================
// Ø®Ø±ÙˆØ¬ÛŒ CSV
// =======================
function exportCSV() {
  const history = engine.getRealityHistory();
  let csv = 'Object,Weight(kg),Volume(m3),KineticEnergy(J),Density,Momentum\n';
  history.forEach((h,i)=>csv+=`Object ${i+1},${h.weight},${h.volume},${h.physics.kinetic_energy},${h.physics.density},${h.physics.momentum}\n`);
  const blob = new Blob([csv],{type:'text/csv'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'hypercalc_data.csv';
  link.click();
}

// =======================
// Ø®Ø±ÙˆØ¬ÛŒ PDF
// =======================
function exportPDF() {
  const doc = new jsPDF();
  const history = engine.getRealityHistory();
  doc.setFontSize(12);
  doc.text('HyperCalc Reality Analysis',10,10);
  let y=20;
  history.forEach((h,i)=>{
    doc.text(`Ø´ÛŒØ¡ ${i+1}: ÙˆØ²Ù†=${h.weight.toFixed(2)}kg, Ø­Ø¬Ù…=${h.volume.toFixed(2)}mÂ³, Ø§Ù†Ø±Ú˜ÛŒ=${h.physics.kinetic_energy.toFixed(2)}J`,10,y);
    y+=10;
  });
  doc.save('hypercalc_report.pdf');
}

// =======================
// Service Worker Ø¨Ø±Ø§ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†
// =======================
if ('serviceWorker' in navigator) {
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js'));
}

</script>

</body>
</html>
    <button>1</button>
    <button>2</button>
    <button>3</button>
    <button class="equal">=</button>

    <button>0</button>
  </div>
</div>

<script src="calculator.js"></script>
<script>
  const display = document.getElementById("display");
  const engine = new CalculatorEngine();

  document.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      const val = btn.textContent;

      if (val === "C") {
        engine.reset();
        display.textContent = "0";
        return;
      }

      if (val === "=") {
        try {
          display.textContent = engine.calculate();
        } catch {
          display.textContent = "Ø®Ø·Ø§";
        }
        return;
      }

      engine.input(val);
      display.textContent = engine.getDisplayValue();
    });
  });
</script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("sw.js");
    });
  }
</script>

</body>
</html>
